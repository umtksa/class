<!DOCTYPE html>
<html>
<head>
<title>Duff - Progress Bars</title> <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
<style>
  body {
    font-family: "Roboto", sans-serif; /* Font ailesi güncellendi */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    margin: 0;
    background-color: #1e1e1e;
    color: #f0f0f0;
    font-weight: 400;
    line-height: 1.6;
  }

  .container {
      background-color: #2d2d2d;
      padding: 20px; /* Padding artırıldı */
      border-radius: 10px;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
      text-align: center;
      width: 95%;
      max-width: 600px;
      box-sizing: border-box;
  }

  button {
    padding: 15px 30px;
    font-size: 1.2rem;
    cursor: pointer;
    border: none;
    border-radius: 5px;
    background-color: #007bff;
    color: white;
    transition: background-color 0.3s ease;
    display: inline-block;
    font-family: sans-serif;
    font-weight: normal;
    margin-bottom: 15px; /* Etiketlerden önce boşluk */
  }

  button:hover:not(:disabled) {
    background-color: #0056b3;
  }

  button:disabled {
      background-color: #555555;
      cursor: not-allowed;
      color: #bbbbbb;
  }

  #label-container {
    margin-top: 10px; /* Butonun margin-bottom'una göre ayarlandı */
    text-align: left;
    width: 100%;
  }

  /* --- YENİ Progress Bar Stilleri --- */
  .progress-label-container {
    margin-bottom: 12px;
    padding: 10px;
    background-color: #3a3a3a;
    border-radius: 5px;
    font-size: 1.1rem; /* Biraz küçültüldü */
    color: #f0f0f0;
    display: flex; /* Flexbox ile hizalama */
    justify-content: space-between;
    align-items: center;
    font-weight: normal;
  }

  .label-name {
      font-weight: normal;
      margin-right: 10px; /* Boşluk ayarlandı */
      flex-basis: 100px; /* Etiket adı için sabit bir genişlik */
      flex-shrink: 0; /* Küçülmesin */
      overflow: hidden; /* Taşarsa gizle */
      text-overflow: ellipsis; /* Taşarsa ... koy */
      white-space: nowrap; /* Tek satırda kalsın */
  }

  .progress-bar-wrapper {
      flex-grow: 1; /* Kalan alanı kaplasın */
      height: 20px; /* Çubuk yüksekliği */
      background-color: #555; /* Boş çubuk rengi */
      border-radius: 5px;
      overflow: hidden; /* Dolgu dışarı taşmasın */
      margin: 0 10px; /* Sağdan soldan boşluk */
  }

  .progress-bar-fill {
      height: 100%;
      width: 0%; /* Başlangıçta boş */
      background-color: #007bff; /* Dolu çubuk rengi */
      border-radius: 5px; /* Sadece sol tarafı yuvarlatmak için */
      transition: width 0.2s ease-out; /* Genişlik değişimine animasyon */
      text-align: right; /* İçine yazı yazılırsa (kullanılmıyor şu an) */
      color: white; /* İçine yazı yazılırsa (kullanılmıyor şu an) */
  }

  .label-percentage {
      font-family: monospace;
      min-width: 45px; /* Yüzde alanı için minimum genişlik */
      text-align: right;
      font-weight: normal;
      flex-shrink: 0; /* Küçülmesin */
  }
  /* --- Progress Bar Stilleri Bitti --- */


   #loading-message {
       font-style: italic;
       color: #aaaaaa;
       margin-bottom: 15px;
       min-height: 1.3rem;
       font-size: 1rem;
       font-weight: normal;
   }

   .hidden-message {
       display: none;
   }

   #loading-message.error {
       color: #ff6b6b;
   }

   .hidden-button {
       display: none !important;
   }

</style>
</head>
<body>

<div class="container">
 <div id="loading-message"></div>
    <button type="button" onclick="init()" disabled id="start-button" class="hidden-button">lesgo</button>
    <div id="label-container"></div>
</div>


<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.4.0/dist/speech-commands.min.js"></script>

<script type="text/javascript">
    const checkpointURL = "https://raw.githubusercontent.com/umtksa/class/refs/heads/main/model.json";
    const metadataURL = "https://raw.githubusercontent.com/umtksa/class/refs/heads/main/metadata.json";

    const NOTHING_LABEL = "Background Noise";
    // HIGHLIGHT_THRESHOLD artık kullanılmıyor
    // const HIGHLIGHT_THRESHOLD = 80;

    let recognizer;
    let classLabels;
    let visibleLabels = []; // { name, originalIndex, div, fillBar, percentageSpan }
    let isListening = false;

    const startButton = document.getElementById("start-button");
    const labelContainer = document.getElementById("label-container");
    const loadingMessage = document.getElementById("loading-message");
    let modelLoaded = false;

    function updateLoadingMessage(message, isError = false) {
        loadingMessage.innerText = message;
        if (message) {
            loadingMessage.classList.remove('hidden-message');
             if (isError) loadingMessage.classList.add('error');
             else loadingMessage.classList.remove('error');
        } else {
            loadingMessage.classList.add('hidden-message');
            loadingMessage.classList.remove('error');
        }
    }

    async function createModel() {
        if (recognizer && modelLoaded) {
             console.log("Model already created and loaded.");
             return recognizer;
         }

        const timestamp = Date.now();
        const checkpointURL_busted = `${checkpointURL}?v=${timestamp}`;
        const metadataURL_busted = `${metadataURL}?v=${timestamp}`;

        console.log("Attempting to create model with busted URLs:", checkpointURL_busted, metadataURL_busted);

        recognizer = speechCommands.create(
            "BROWSER_FFT", undefined, checkpointURL_busted, metadataURL_busted
        );

        console.log("Recognizer created, awaiting ensureModelLoaded...");
        await recognizer.ensureModelLoaded();
        modelLoaded = true;
        console.log("Model and metadata ensured loaded successfully.");

        classLabels = recognizer.wordLabels();
        console.log("All class labels from model:", classLabels);
        return recognizer;
    }

    async function init() {
        if (isListening) {
            console.log("Zaten dinleniyor.");
            return;
        }

        updateLoadingMessage("Mikrofon izni bekleniyor...");
        startButton.classList.add('hidden-button');
        labelContainer.innerHTML = '';
        visibleLabels = [];

        try {
             await createModel();

             // *** ETİKETLERİ VE PROGRESS BAR YAPISINI OLUŞTUR ***
             for (let i = 0; i < classLabels.length; i++) {
                const label = classLabels[i];
                if (label !== NOTHING_LABEL) {
                    const labelDiv = document.createElement("div");
                    // Yeni class eklendi
                    labelDiv.classList.add('progress-label-container');

                    // Progress bar yapısını içeren HTML
                    labelDiv.innerHTML = `
                        <span class="label-name">${label}</span>
                        <div class="progress-bar-wrapper">
                            <div class="progress-bar-fill"></div>
                        </div>
                        <span class="label-percentage">0%</span>
                    `;
                    labelContainer.appendChild(labelDiv);

                    // Gerekli elementlere referansları sakla
                    visibleLabels.push({
                        name: label,
                        originalIndex: i,
                        div: labelDiv, // Ana div
                        fillBar: labelDiv.querySelector('.progress-bar-fill'), // Dolgu çubuğu
                        percentageSpan: labelDiv.querySelector('.label-percentage') // Yüzde metni
                    });
                }
             }
             console.log("Visible labels with progress bars created:", visibleLabels.map(l => l.name));
             // *********************************************************

             updateLoadingMessage("");

             console.log("Starting recognizer listen...");
             recognizer.listen(result => {
                 const scores = result.scores;

                 // Her görünür etiket için ilerleme çubuğunu ve yüzdeyi güncelle
                 visibleLabels.forEach(item => {
                      const score = scores[item.originalIndex];
                      const percentage = Math.round(score * 100);

                      // İlerleme çubuğunun genişliğini güncelle
                      item.fillBar.style.width = `${percentage}%`;

                      // Yüzde metnini güncelle
                      item.percentageSpan.innerText = `${percentage}%`;

                      // Vurgulama (highlight) kodu kaldırıldı
                 });

             }, {
                 includeSpectrogram: true,
                 overlapFactor: 0.50
             });

             isListening = true;
             console.log("Dinleme Başladı.");

         } catch (error) {
             console.error("Model veya mikrofon başlatılırken bir hata oluştu:", error);
             updateLoadingMessage("Hata: Mikrofon başlatılamadı veya model yüklenemedi. Lütfen mikrofon iznini kontrol edin.", true);
             startButton.classList.remove('hidden-button');
             startButton.disabled = true;
             isListening = false;
             labelContainer.innerHTML = '';
             visibleLabels = [];
         }
    }

    async function stopListening() {
        if (recognizer && isListening) {
            await recognizer.stopListening();
            isListening = false;
            console.log("Dinleme durduruldu.");
            startButton.classList.remove('hidden-button');
            startButton.disabled = false;
            updateLoadingMessage("Dinleme durduruldu.");

             // Progress barları ve yüzdeleri sıfırla
             visibleLabels.forEach(item => {
                 item.fillBar.style.width = '0%'; // Genişliği sıfırla
                 item.percentageSpan.innerText = '0%'; // Metni sıfırla
             });
             // Eğer visibleLabels boşsa (init hiç çalışmadıysa), labelContainer'ı tamamen temizle
             if (visibleLabels.length === 0) {
                 labelContainer.innerHTML = '';
             }
        }
    }

    async function preloadModel() {
        try {
            updateLoadingMessage("");
            startButton.disabled = true;
            startButton.classList.remove('hidden-button');
            await createModel();
            updateLoadingMessage("");
            startButton.disabled = false;
            startButton.innerText = "lesgo";
            console.log("Model ön yüklendi. Başlamak için 'lesgo' butonuna basın.");
        } catch (error) {
            console.error("Model ön yüklenirken bir hata oluştu:", error);
            updateLoadingMessage("Hata: Model ön yüklenemedi.", true);
            startButton.disabled = true;
            startButton.classList.remove('hidden-button');
            startButton.innerText = "Hata";
        }
    }

    preloadModel();

</script>

</body>
</html>