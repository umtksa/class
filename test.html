<!DOCTYPE html>
<html>
<head>
<title>Duff - Div as Progress Bar</title> <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
<style>
  body {
    font-family: "Roboto", sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    margin: 0;
    background-color: #1e1e1e;
    color: #f0f0f0;
    font-weight: 400;
    line-height: 1.6;
  }

  .container {
      background-color: #2d2d2d;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
      text-align: center;
      width: 95%;
      max-width: 600px;
      box-sizing: border-box;
  }

  button {
    padding: 15px 30px;
    font-size: 1.2rem;
    cursor: pointer;
    border: none;
    border-radius: 5px;
    background-color: #007bff;
    color: white;
    transition: background-color 0.3s ease;
    display: inline-block;
    font-family: sans-serif;
    font-weight: normal;
    margin-bottom: 15px;
  }

  button:hover:not(:disabled) {
    background-color: #0056b3;
  }

  button:disabled {
      background-color: #555555;
      cursor: not-allowed;
      color: #bbbbbb;
  }

  #label-container {
    margin-top: 10px;
    text-align: left;
    width: 100%;
  }

  /* --- Div'in Kendisi Progress Bar Stilleri --- */
  .progress-label-container {
    margin-bottom: 12px;
    padding: 12px 15px;
    background-color: #3a3a3a; /* Başlangıç arka plan rengi (boş kısım) */
    border-radius: 5px;
    font-size: 1.1rem;
    color: #f0f0f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: normal;
    overflow: hidden;
    /* Gradyan değişimini yumuşatmak için transition */
    /* --- SÜRE ARTIRILDI --- */
    transition: background 1s ease-out; /* 0.2s yerine 0.6s (veya istediğiniz başka bir değer) */
    /* --- --- --- --- --- */
  }

  .label-name {
      font-weight: normal;
      margin-right: 15px;
      flex-shrink: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
       z-index: 1;
       position: relative;
  }

  .label-percentage {
      font-family: monospace;
      min-width: 45px;
      text-align: right;
      font-weight: normal;
      flex-shrink: 0;
      z-index: 1;
      position: relative;
  }

  /* Eski progress bar stilleri kaldırıldı (.progress-bar-wrapper, .progress-bar-fill) */
  /* --- Progress Bar Stilleri Bitti --- */


   #loading-message {
       font-style: italic;
       color: #707070;
       margin-bottom: 15px;
       min-height: 1.3rem;
       font-size: 1rem;
       font-weight: normal;
   }

   .hidden-message {
       display: none;
   }

   #loading-message.error {
       color: #ff6b6b;
   }

   .hidden-button {
       display: none !important;
   }

</style>
</head>
<body>

<div class="container">
 <div id="loading-message"></div>
    <button type="button" onclick="init()" disabled id="start-button" class="hidden-button">lesgo</button>
    <div id="label-container"></div>
</div>


<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.4.0/dist/speech-commands.min.js"></script>

<script type="text/javascript">
    const checkpointURL = "https://raw.githubusercontent.com/umtksa/class/refs/heads/main/model.json";
    const metadataURL = "https://raw.githubusercontent.com/umtksa/class/refs/heads/main/metadata.json";

    const NOTHING_LABEL = "Background Noise";
    const FILL_COLOR = '#bbbbbb'; // Açık Gri Dolgu Rengi (biraz daha açık)
    const EMPTY_COLOR = '#3a3a3a'; // Boş Kısım Rengi (CSS ile aynı)

    let recognizer;
    let classLabels;
    let visibleLabels = []; // { name, originalIndex, div, percentageSpan }
    let isListening = false;

    const startButton = document.getElementById("start-button");
    const labelContainer = document.getElementById("label-container");
    const loadingMessage = document.getElementById("loading-message");
    let modelLoaded = false;

    function updateLoadingMessage(message, isError = false) {
        loadingMessage.innerText = message;
        if (message) {
            loadingMessage.classList.remove('hidden-message');
             if (isError) loadingMessage.classList.add('error');
             else loadingMessage.classList.remove('error');
        } else {
            loadingMessage.classList.add('hidden-message');
            loadingMessage.classList.remove('error');
        }
    }

    async function createModel() {
        if (recognizer && modelLoaded) {
             console.log("Model already created and loaded.");
             return recognizer;
         }

        const timestamp = Date.now();
        const checkpointURL_busted = `${checkpointURL}?v=${timestamp}`;
        const metadataURL_busted = `${metadataURL}?v=${timestamp}`;

        console.log("Attempting to create model with busted URLs:", checkpointURL_busted, metadataURL_busted);

        recognizer = speechCommands.create(
            "BROWSER_FFT", undefined, checkpointURL_busted, metadataURL_busted
        );

        console.log("Recognizer created, awaiting ensureModelLoaded...");
        await recognizer.ensureModelLoaded();
        modelLoaded = true;
        console.log("Model and metadata ensured loaded successfully.");

        classLabels = recognizer.wordLabels();
        console.log("All class labels from model:", classLabels);
        return recognizer;
    }

    async function init() {
        if (isListening) {
            console.log("Zaten dinleniyor.");
            return;
        }

        updateLoadingMessage("Mikrofon izni bekleniyor...");
        startButton.classList.add('hidden-button');
        labelContainer.innerHTML = '';
        visibleLabels = [];

        try {
             await createModel();

             // *** ETİKETLERİ VE SADELEŞTİRİLMİŞ YAPISINI OLUŞTUR ***
             for (let i = 0; i < classLabels.length; i++) {
                const label = classLabels[i];
                if (label !== NOTHING_LABEL) {
                    const labelDiv = document.createElement("div");
                    labelDiv.classList.add('progress-label-container'); // Ana div'e class

                    // Sadece isim ve yüzde span'ları
                    labelDiv.innerHTML = `
                        <span class="label-name">${label}</span>
                        <span class="label-percentage">0%</span>
                    `;
                    labelContainer.appendChild(labelDiv);

                    // Ana div ve yüzde span'ına referansları sakla
                    visibleLabels.push({
                        name: label,
                        originalIndex: i,
                        div: labelDiv, // Ana div (arka planı değişecek)
                        percentageSpan: labelDiv.querySelector('.label-percentage')
                    });
                }
             }
             console.log("Visible labels (div as progress bar) created:", visibleLabels.map(l => l.name));
             // *********************************************************

             updateLoadingMessage("");

             console.log("Starting recognizer listen...");
             recognizer.listen(result => {
                 const scores = result.scores;

                 // Her görünür etiket için div'in arka planını ve yüzdeyi güncelle
                 visibleLabels.forEach(item => {
                      const score = scores[item.originalIndex];
                      const percentage = Math.round(score * 100);

                      // Div'in arka planını linear-gradient ile güncelle
                      // Gradyan: sağa doğru, Dolu Renk yüzdeye kadar, sonra Boş Renk
                      item.div.style.background = `linear-gradient(to right, ${FILL_COLOR} ${percentage}%, ${EMPTY_COLOR} ${percentage}%)`;

                      // Yüzde metnini güncelle
                      item.percentageSpan.innerText = `${percentage}%`;
                 });

             }, {
                 includeSpectrogram: true,
                 overlapFactor: 0.50
             });

             isListening = true;
             console.log("Dinleme Başladı.");

         } catch (error) {
             console.error("Model veya mikrofon başlatılırken bir hata oluştu:", error);
             updateLoadingMessage("Hata: Mikrofon başlatılamadı veya model yüklenemedi. Lütfen mikrofon iznini kontrol edin.", true);
             startButton.classList.remove('hidden-button');
             startButton.disabled = true;
             isListening = false;
             labelContainer.innerHTML = '';
             visibleLabels = [];
         }
    }

    async function stopListening() {
        if (recognizer && isListening) {
            await recognizer.stopListening();
            isListening = false;
            console.log("Dinleme durduruldu.");
            startButton.classList.remove('hidden-button');
            startButton.disabled = false;
            updateLoadingMessage("Dinleme durduruldu.");

             // Div'lerin arka planını ve yüzdeleri sıfırla
             visibleLabels.forEach(item => {
                 // Arka planı varsayılan renge döndür (inline stili kaldırarak veya varsayılanı ayarlayarak)
                 item.div.style.background = ''; // Inline stili kaldırmak genellikle daha temizdir
                 // Alternatif: item.div.style.background = EMPTY_COLOR;
                 item.percentageSpan.innerText = '0%'; // Metni sıfırla
             });
             if (visibleLabels.length === 0) {
                 labelContainer.innerHTML = '';
             }
        }
    }

    async function preloadModel() {
        try {
            updateLoadingMessage("Yükleniyor..."); // Mesaj güncellendi
            startButton.disabled = true;
            startButton.classList.remove('hidden-button'); // İlk başta görünsün
            await createModel();
            updateLoadingMessage(""); // Yükleme bitince mesajı kaldır
            startButton.disabled = false;
            startButton.innerText = "lesgo";
            console.log("Model ön yüklendi. Başlamak için 'lesgo' butonuna basın.");
        } catch (error) {
            console.error("Model ön yüklenirken bir hata oluştu:", error);
            updateLoadingMessage("Hata: Model ön yüklenemedi.", true);
            startButton.disabled = true;
            startButton.classList.remove('hidden-button'); // Hata durumunda da görünsün
            startButton.innerText = "Hata";
        }
    }

    preloadModel();

</script>

</body>
</html>